    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>JobBoard - JobDetails</title>
        <!-- link bootstrap -->
             <link rel="icon" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/svgs/solid/briefcase.svg" type="image/svg+xml">

        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
        <link rel="stylesheet" href="css/style.css">
    </head>
    <body>
        <button class="theme-toggle" onclick="toggleTheme()">
            <i class="bi bi-moon-fill" id="theme-icon"></i>
        </button>

        <nav class="navbar navbar-expand-lg">
            <div class="container">
                <div class="d-flex justify-content-between align-items-center w-100">
                <a class="navbar-brand text-primary-custom fw-bold" href="#">
                    <i class="bi bi-briefcase-fill me-2 text-secondary-custom"></i>JobBoard
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav mx-auto">
                        <li class="nav-item"><a href="index.html" class="nav-link"><i class="bi bi-search"></i> Browse Jobs</a></li>
                        <li class="nav-item"><a href="saved-jobs.html" class="nav-link"><i class="bi bi-bookmark-fill"></i> Saved Jobs</a></li>
                        <li class="nav-item"><a href="cv.html" class="nav-link"><i class="bi bi-file-earmark-text-fill"></i> CV Manager</a></li>
                    </ul>
                </div>
                
                <div class="d-flex align-items-center">
                    <!-- Login and Register buttons for visitors -->
                    <div id="visitor-buttons" class="d-none">
                        <a href="login.html" class="btn btn-outline-secondary me-2">Login</a>
                        <a href="register.html" class="btn btn-primary">Register</a>
                    </div>

                    <!-- User dropdown for logged-in users -->
                    <div class="dropdown" id="user-dropdown">
                        <a class="btn btn-outline-secondary border-0 d-flex align-items-center" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-person-circle fs-5 me-2"></i>
                            <span id="user-display-name" class="d-none d-lg-inline"></span>
                        </a>

                        <ul class="dropdown-menu dropdown-menu-end custom-card p-0 mt-2">
                            <li><a class="dropdown-item" href="profile.html"><i class="bi bi-person-fill me-2"></i> My Profile</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><button class="dropdown-item text-danger" id="logout-btn"><i class="bi bi-box-arrow-right me-2"></i> Logout</button></li>
                        </ul>
                    </div>
                </div>
                </div>
            </div>
        </nav>
        
    <!--start job details -->
    <div class="container box-container pb-5">
        <a href="index.html" class="text-secondary text-decoration-none small mb-4 d-inline-block">
            <i class="bi bi-arrow-left me-2"></i>Back to jobs </a>
            <!-- first part-->
        <div class="card border-0 shadow-sm rounded-4 mb-4">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between">
                    <div class="d-flex gap-4">
                        <img src="" alt="" class="header-logo rounded-3 border image-w" id="company-logo">
                        <div>
                            <h4 class="fw-bold mb-1" id="job-title">Loading...</h4>
                            <p class="text-secondary mb-3" id="company-name">Loading...</p>
                            <div class="d-flex gap-2" id="job-skills">
                                <span class="badge skill">Loading...</span>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex flex-column gap-2">
        <button class="btn btn-outline-secondary" id="save-job-btn">
            <i class="bi bi-bookmark me-2" id="save-job-icon"></i>
            <span id="save-job-text">Save Job</span>
        </button>
    </div>
                </div>
                <div class="row mt-4 pt-3 border-top text-secondary small gy-3">
                    <div class="col-md-3" id="job-location"><i class="bi bi-geo-alt me-2"></i>Loading...</div>
                    <div class="col-md-3" id="job-type"><i class="bi bi-briefcase me-2"></i>Loading...</div>
                    <div class="col-md-3" id="job-salary"><i class="bi bi-currency-dollar me-2"></i>Loading...</div>
                    <div class="col-md-3" id="job-posted"><i class="bi bi-clock me-2"></i>Loading...</div>
                </div>
                <button class="btn btn-apply mt-4 px-5 py-2 fw-medium" id="apply-now-btn">Apply Now</button>
            </div>
        </div>

        <div class="row g-4">
            <!-- job description -->
            <div class="col-lg-8">
                <div class="card border-0 shadow-sm rounded-4 mb-4">
                    <div class="card-body p-4">
                        <h6 class="fw-bold mb-3">Job Description</h6>
                        <p class="text-secondary small" id="job-description">Loading...</p>
                    </div>
                </div>
    <!-- responsabilities -->
                <div class="card border-0 shadow-sm rounded-4 mb-4">
                    <div class="card-body p-4">
                        <h6 class="fw-bold mb-3">Responsibilities</h6>
                        <ul class="text-secondary small bullet-list" id="job-responsibilities">
                            <li>Loading...</li>
                        </ul>
                    </div>
                </div>

                </div>

            <div class="col-lg-4">
                <div class="card border-0 shadow-sm rounded-4 mb-4">
                    <div class="card-body p-4">
                        <h6 class="fw-bold mb-4" id="company-name-sidebar">About Loading...</h6>
                        <div class="sidebar-info mb-3">
                            <label class="text-muted x-small d-block mb-1"><i class="bi bi-building me-2"></i>Industry</label>
                            <p class="small fw-semibold mb-0" id="company-industry">Loading...</p>
                        </div>
                        <div class="sidebar-info mb-3">
                            <label class="text-muted x-small d-block mb-1"><i class="bi bi-people me-2"></i>Company Size</label>
                            <p class="small fw-semibold mb-0" id="company-size">Loading...</p>
                        </div>
                        <div class="sidebar-info mb-4">
                            <label class="text-muted x-small d-block mb-1"><i class="bi bi-calendar-check me-2"></i>Founded</label>
                            <p class="small fw-semibold mb-0" id="company-founded">Loading...</p>
                        </div>
                        <button class="btn btn-out w-100 py-2 small">View Company Page</button>
                    </div>
                </div>
            </div>
            <!-- requirements -->
            <div class="col-lg-8">
        <div class="card border-0 shadow-sm rounded-4 mb-4">
            <div class="card-body p-4">
                <h6 class="fw-bold mb-3">Requirements</h6>
                <ul class="text-secondary small bullet-list mb-0" id="job-requirements">
                    <li>Loading...</li>
                </ul>
            </div>
        </div>
    <!-- benefits &perks -->
        <div class="card border-0 shadow-sm rounded-4 mb-4">
            <div class="card-body p-4">
                <h6 class="fw-bold mb-3">Benefits & Perks</h6>
                <ul class="text-secondary small bullet-list mb-0" id="job-benefits">
                    <li>Loading...</li>
                </ul>
            </div>
        </div>
    </div>
    <!-- similar jobs -->
    <div class="col-lg-4">
        <div class="card border-0 shadow-sm rounded-4">
            <div class="card-body p-4">
                <h6 class="fw-bold mb-4">Similar Jobs</h6>
                <div id="similar-jobs-container">
                    <!-- Similar jobs will be loaded dynamically -->
                </div>
            </div>
        </div>
    </div>
        </div>
    </div>

    <!-- apply form -->
    <div class="modal fade" id="applyModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 rounded-4 shadow">
                <div class="modal-body p-5">
                    <div class="text-center mb-5">
                        <h4 class="fw-bold mb-1">Apply for Position</h4>
                        <p class="text-muted small" id="apply-modal-subtitle">Loading...</p>
                    </div>

                    <form id="applicationForm">
                        <h6 class="fw-bold mb-3 small">Personal Information</h6>
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label class="form-label x-small fw-semibold text-muted">Full Name *</label>
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text bg-white border-end-0 text-muted"><i class="bi bi-person"></i></span>
                                    <input type="text" name="full_name" class="form-control border-start-0 ps-0" placeholder="John Doe" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label x-small fw-semibold text-muted">Email Address *</label>
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text bg-white border-end-0 text-muted"><i class="bi bi-envelope"></i></span>
                                    <input type="email" name="email" class="form-control border-start-0 ps-0" placeholder="you@example.com" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label x-small fw-semibold text-muted">Phone Number</label>
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text bg-white border-end-0 text-muted"><i class="bi bi-telephone"></i></span>
                                    <input type="tel" name="phone" class="form-control border-start-0 ps-0" placeholder="+1 (555) 123-4567">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label x-small fw-semibold text-muted">LinkedIn Profile</label>
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text bg-white border-end-0 text-muted"><i class="bi bi-linkedin"></i></span>
                                    <input type="url" name="linkedin" class="form-control border-start-0 ps-0" placeholder="linkedin.com/in/johndoe">
                                </div>
                            </div>
                            <div class="col-12">
                                <label class="form-label x-small fw-semibold text-muted">Portfolio / Website</label>
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text bg-white border-end-0 text-muted"><i class="bi bi-link-45deg"></i></span>
                                    <input type="url" name="portfolio" class="form-control border-start-0 ps-0" placeholder="https://yourportfolio.com">
                                </div>
                            </div>
                        </div>

                        <h6 class="fw-bold mb-3 small">Select Resume / CV *</h6>
                        <div class="mb-4">
                            <select class="form-select" id="cvSelect" name="cvSelect">
                                <option value="">Choose a CV...</option>
                            </select>
                            <div class="form-text small text-muted">Select from your uploaded CVs</div>
                        </div>
                        <div class="mb-3">
                            <a href="#" id="uploadNewCvLink" class="text-primary small">Or upload a new CV</a>
                        </div>

                        <div id="uploadNewCvSection" class="d-none mb-4">
                            <h6 class="fw-bold mb-3 small">Upload New CV</h6>
                            <div class="mb-3">
                                <label class="form-label x-small fw-semibold text-muted">CV Name *</label>
                                <input type="text" class="form-control form-control-sm" id="newCvName" placeholder="e.g., Senior Developer Resume" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label x-small fw-semibold text-muted">Select File *</label>
                                <input type="file" class="form-control form-control-sm" id="newCvFile" accept=".pdf,.doc,.docx" required>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="newCvPrimary">
                                <label class="form-check-label x-small text-muted" for="newCvPrimary">
                                    Set as Primary CV
                                </label>
                            </div>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-primary btn-sm" id="uploadNewCvBtn">Upload CV</button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" id="cancelUploadBtn">Cancel</button>
                            </div>
                        </div>

                        <h6 class="fw-bold mb-3 small">Cover Letter *</h6>
                        <div class="mb-4">
                            <textarea class="form-control small" rows="4" name="cover_letter" id="cover_letter" placeholder="Tell us why you're a great fit for this position..."></textarea>
                            <div class="d-flex justify-content-between mt-1">
                                <span class="x-small text-muted" id="char-counter">0 / 500 characters minimum</span>
                            </div>
                        </div>

                        <div class="form-check mb-4">
                            <input class="form-check-input" type="checkbox" id="consent" name="consent" required>
                            <label class="form-check-label x-small text-muted" for="consent">
                                I consent to the processing of my personal data for recruitment purposes and confirm that all information provided is accurate.
                            </label>
                        </div>

                        <div class="row g-2">
                            <div class="col-6">
                                <button type="submit" class="btn btn-apply w-100 py-2" id="submit-application-btn">Submit Application</button>
                            </div>
                            <div class="col-6">
                                <button type="button" class="btn btn-out w-100 py-2" data-bs-dismiss="modal">Cancel</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- footer -->
    <footer class="footer mt-auto">
        <div class="container">
            <div class="row">
                <div class="col-md-3 mb-4">
                    <h5 class="fw-bold"><i class="bi bi-briefcase-fill me-2 text-secondary-custom"></i>JobBoard</h5>
                    <p class="text-white-50">Your trusted platform for finding the perfect career opportunity.</p>
                </div>
                <div class="col-md-3 mb-4">
                    <h6 class="fw-bold text-secondary-custom mb-3">For Job Seekers</h6>
                    <ul class="list-unstyled">
                        <li><a href="index.html">Browse Jobs</a></li>
                        <li><a href="cv.html">Career Advice</a></li>
                        <li><a href="cv.html">Resume Tips</a></li>
                    </ul>
                </div>
                <div class="col-md-3 mb-4">
                    <h6 class="fw-bold text-secondary-custom mb-3">Company</h6>
                    <ul class="list-unstyled">
                        <li><a href="about.html">About Us</a></li>
                        <li><a href="terms.html">Terms of Service</a></li>
                        <li><a href="privacy.html">Privacy Policy</a></li>
                    </ul>
                </div>
                <div class="col-md-3 mb-4">
                    <h6 class="fw-bold text-secondary-custom mb-3">Connect</h6>
                    <ul class="list-unstyled">
                        <li><a href="#"><i class="bi bi-linkedin me-2"></i>LinkedIn</a></li>
                        <li><a href="#"><i class="bi bi-twitter-x me-2"></i>Twitter</a></li>
                        <li><a href="#"><i class="bi bi-facebook me-2"></i>Facebook</a></li>
                    </ul>
                </div>
            </div>
            <hr style="border-color: rgba(255, 255, 255, 0.1);">
            <div class="text-center text-white-50 mt-3">
                Â© 2025 JobBoard. All rights reserved.
            </div>
        </div>
    </footer>
        <!-- link js -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
        <script src="js/theme.js"></script>
        <script src="js/navbar.js"></script>
        <script src="js/profile.js"></script>

        <script type="module">
            import { ProfileModel } from './models/ProfileModel.js';
            import { CvModel } from './models/CvModel.js';

            const requiredFields = ['full_name', 'email', 'cvSelect', 'cover_letter', 'consent'];

            document.addEventListener('DOMContentLoaded', () => {
                // Initialize Modal
                const applyModal = new bootstrap.Modal(document.getElementById('applyModal'));

                // Character counter for cover letter
                const coverLetterTextarea = document.getElementById('cover_letter');
                const charCounter = document.getElementById('char-counter');
                const submitBtn = document.getElementById('submit-application-btn');

                function updateCharCounter() {
                    const length = coverLetterTextarea.value.length;
                    charCounter.textContent = `${length} / 500 characters minimum`;
                    charCounter.classList.toggle('text-danger', length < 500);
                    charCounter.classList.toggle('text-success', length >= 500);
                    validateForm();
                }

                function validateForm() {
                    let isValid = true;

                    // Check if user is uploading a new CV
                    const uploadSectionVisible = !document.getElementById('uploadNewCvSection').classList.contains('d-none');
                    const newCvName = document.getElementById('newCvName').value.trim();
                    const newCvFile = document.getElementById('newCvFile').files[0];

                    // Adjust required fields based on CV selection
                    const adjustedRequiredFields = requiredFields.filter(field => {
                        if (field === 'cvSelect') {
                            // cvSelect is not required if uploading new CV
                            return !uploadSectionVisible || !newCvName || !newCvFile;
                        }
                        return true;
                    });

                    adjustedRequiredFields.forEach(field => {
                        const element = document.getElementById(field) || document.querySelector(`[name="${field}"]`);
                        if (element) {
                            if (!element.value || (element.type === 'checkbox' && !element.checked)) {
                                element.classList.add('is-invalid');
                                isValid = false;
                            } else {
                                element.classList.remove('is-invalid');
                            }
                        }
                    });

                    // Additional validation for new CV upload
                    if (uploadSectionVisible) {
                        if (!newCvName) {
                            document.getElementById('newCvName').classList.add('is-invalid');
                            isValid = false;
                        } else {
                            document.getElementById('newCvName').classList.remove('is-invalid');
                        }
                        if (!newCvFile) {
                            document.getElementById('newCvFile').classList.add('is-invalid');
                            isValid = false;
                        } else {
                            document.getElementById('newCvFile').classList.remove('is-invalid');
                        }
                    }

                    // Check cover letter length
                    const coverLetterValue = coverLetterTextarea.value;
                    if (coverLetterValue.length < 500) {
                        coverLetterTextarea.classList.add('is-invalid');
                        isValid = false;
                    } else {
                        coverLetterTextarea.classList.remove('is-invalid');
                    }

                    // Enable/disable submit button
                    submitBtn.disabled = !isValid;
                    return isValid;
                }

                coverLetterTextarea.addEventListener('input', updateCharCounter);

                // Add validation listeners
                requiredFields.forEach(field => {
                    const element = document.getElementById(field) || document.querySelector(`[name="${field}"]`);
                    if (element) {
                        element.addEventListener('input', validateForm);
                        element.addEventListener('change', validateForm);
                    }
                });

                // Select Apply button
                const applyBtn = document.querySelector('#apply-now-btn');
                applyBtn.addEventListener('click', (e) => {
                    // If it's the main page button, prevent default and show modal
                    if (!e.target.closest('.modal-body')) {
                        const user = JSON.parse(localStorage.getItem("currentUser"));
                        if (!user) {
                            alert('Please log in to apply for this position.');
                            window.location.href = 'login.html';
                            return;
                        }

                        // Check if already applied
                        if (applyBtn.disabled && applyBtn.textContent === 'Applied') {
                            return; // Don't show modal if already applied
                        }

                        applyModal.show();
                    }
                });

                // Populate CV select when modal is shown
                applyModal._element.addEventListener('show.bs.modal', () => {
                    // Update modal subtitle with job details
                    if (window.currentJob) {
                        document.getElementById('apply-modal-subtitle').textContent = `${window.currentJob.title} at ${window.currentJob.company}`;
                    }

                    const user = JSON.parse(localStorage.getItem("currentUser"));
                    if (user) {
                        const cvs = CvModel.getAll(user.id);
                        const cvSelect = document.getElementById('cvSelect');
                        cvSelect.innerHTML = '<option value="">Choose a CV...</option>';

                        cvs.forEach(cv => {
                            const option = document.createElement('option');
                            option.value = cv.id;
                            option.textContent = cv.name + (cv.isPrimary ? ' (Primary)' : '');
                            cvSelect.appendChild(option);
                        });
                    }
                });

                // Handle upload new CV link
                document.getElementById('uploadNewCvLink').addEventListener('click', (e) => {
                    e.preventDefault();
                    const section = document.getElementById('uploadNewCvSection');
                    section.classList.toggle('d-none');
                });

                // Handle cancel upload
                document.getElementById('cancelUploadBtn').addEventListener('click', () => {
                    const section = document.getElementById('uploadNewCvSection');
                    section.classList.add('d-none');
                    // Reset form
                    document.getElementById('newCvName').value = '';
                    document.getElementById('newCvFile').value = '';
                    document.getElementById('newCvPrimary').checked = false;
                });

                // Handle upload new CV
                document.getElementById('uploadNewCvBtn').addEventListener('click', () => {
                    const user = JSON.parse(localStorage.getItem("currentUser"));
                    if (!user) {
                        alert('Please log in to upload a CV.');
                        return;
                    }

                    const name = document.getElementById('newCvName').value.trim();
                    const file = document.getElementById('newCvFile').files[0];
                    const isPrimary = document.getElementById('newCvPrimary').checked;

                    if (!name) {
                        alert('Please enter a CV name.');
                        return;
                    }
                    if (!file) {
                        alert('Please select a file.');
                        return;
                    }

                    // Simulate file upload - in real app, upload to server
                    const newCv = {
                        id: Date.now(), // Simple ID generation
                        name: name,
                        file: file.name, // Store filename
                        isPrimary: isPrimary,
                        size: (file.size / 1024).toFixed(0) + ' KB',
                        modified: new Date().toLocaleDateString(),
                        status: 'Active'
                    };

                    CvModel.add(user.id, newCv);

                    // Refresh CV select
                    const cvs = CvModel.getAll(user.id);
                    const cvSelect = document.getElementById('cvSelect');
                    cvSelect.innerHTML = '<option value="">Choose a CV...</option>';
                    cvs.forEach(cv => {
                        const option = document.createElement('option');
                        option.value = cv.id;
                        option.textContent = cv.name + (cv.isPrimary ? ' (Primary)' : '');
                        cvSelect.appendChild(option);
                    });

                    // Hide section and reset form
                    document.getElementById('uploadNewCvSection').classList.add('d-none');
                    document.getElementById('newCvName').value = '';
                    document.getElementById('newCvFile').value = '';
                    document.getElementById('newCvPrimary').checked = false;

                    alert('CV uploaded successfully!');
                });

                // Form submission
                const form = document.getElementById('applicationForm');
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    const user = JSON.parse(localStorage.getItem("currentUser"));
                    if (!user) {
                        alert('Please log in to apply for this position.');
                        return;
                    }

                    if (!window.currentJob) {
                        alert('Job details not loaded. Please refresh the page and try again.');
                        return;
                    }

                    let isValid = true;
                    requiredFields.forEach(field => {
                        const element = document.getElementById(field) || document.querySelector(`[name="${field}"]`);
                        if (element && (!element.value || (element.type === 'checkbox' && !element.checked))) {
                            element.classList.add('is-invalid');
                            isValid = false;
                        } else if (element) {
                            element.classList.remove('is-invalid');
                        }
                    });

                    // Check cover letter character count
                    const coverLetterValue = coverLetterTextarea.value;
                    if (coverLetterValue.length < 500) {
                        coverLetterTextarea.classList.add('is-invalid');
                        isValid = false;
                        alert('Cover letter must be at least 500 characters long.');
                        return;
                    } else {
                        coverLetterTextarea.classList.remove('is-invalid');
                    }

                    if (!isValid) {
                        alert('Please fill in all required fields.');
                        return;
                    }

                    // Collect form data
                    const formData = new FormData(form);
                    const cvId = formData.get('cvSelect') ? parseInt(formData.get('cvSelect')) : null;
                    const applicationData = {
                        job_id: window.currentJob.id,
                        user_id: user.id,
                        full_name: formData.get('full_name') || '',
                        email: formData.get('email') || '',
                        phone: formData.get('phone') || null,
                        linkedin: formData.get('linkedin') || null,
                        portfolio: formData.get('portfolio') || null,
                        cv_id: cvId,
                        cover_letter: formData.get('cover_letter') || '',
                        consent: formData.get('consent') === 'on'
                    };

                    try {
                        const response = await fetch('http://127.0.0.1:8000/applications', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(applicationData)
                        });

                        if (response.ok) {
                            const result = await response.json();
                            console.log('Application submitted:', result);

                            // Save application locally after successful server submission
                            ProfileModel.load(user.id);

                            const cvs = CvModel.getAll(user.id);
                            const selectedCv = cvs.find(cv => cv.id === cvId);

                            const appliedJob = {
                                jobId: window.currentJob.id,
                                title: window.currentJob.title,
                                company: window.currentJob.company,
                                location: window.currentJob.location,
                                cvId: cvId,
                                cvName: selectedCv ? selectedCv.name : "Unknown CV",
                                appliedAt: new Date().toLocaleDateString()
                            };

                            ProfileModel.addAppliedJob(appliedJob);
                            ProfileModel.save(user.id);

                            // Show alert and close modal
                            alert('submit successfully');
                            applyModal.hide();

                            // Update button status after successful submission
                            const applyBtn = document.querySelector('#apply-now-btn');
                            applyBtn.textContent = 'Applied';
                            applyBtn.classList.remove('btn-apply');
                            applyBtn.classList.add('btn-success');
                            applyBtn.disabled = true;
                        } else {
                            const error = await response.json();
                            alert('Application submission failed: ' + (error.detail || 'Unknown error'));
                        }
                    } catch (error) {
                        console.error('Error submitting application:', error);
                        alert('Application submission failed. Please check your connection.');
                    }
                });
            });
        </script>

    <script>
        // Global variables
        let savedJobs = JSON.parse(localStorage.getItem('savedJobs')) || [];
        let currentJob = null;

        // Load job details
        async function loadJob() {
            const jobId = new URLSearchParams(window.location.search).get("id");
            if (!jobId) {
                console.error("No job ID provided");
                showErrorMessage("No job ID provided in the URL.");
                return;
            }

            // Show loading state
            setLoadingState(true);

            try {
                const response = await fetch(`http://127.0.0.1:8000/jobs/${jobId}`);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                currentJob = await response.json();
                window.currentJob = currentJob;

                // Populate job details
                document.querySelector('#company-logo').src = currentJob.company_logo || '';
                document.querySelector('#company-logo').alt = currentJob.company || 'Company Logo';
                document.getElementById('job-title').textContent = currentJob.title || 'Job Title Not Available';
                document.getElementById('company-name').textContent = currentJob.company || 'Company Not Specified';

                // Skills
                const skillsContainer = document.getElementById('job-skills');
                skillsContainer.innerHTML = `
                    <span class="badge skill">${currentJob.job_type || 'N/A'}</span>
                    <span class="badge skill">${currentJob.experience_level || 'N/A'}</span>
                    <span class="badge skill">${currentJob.remote || 'N/A'}</span>
                `;

                // Job info
                document.getElementById('job-location').innerHTML = `<i class="bi bi-geo-alt me-2"></i>${currentJob.location || 'Location not specified'}`;
                document.getElementById('job-type').innerHTML = `<i class="bi bi-briefcase me-2"></i>${currentJob.job_type || 'Type not specified'}`;
                document.getElementById('job-salary').innerHTML = `<i class="bi bi-currency-dollar me-2"></i>${currentJob.salary_range || 'Salary not specified'}`;
                document.getElementById('job-posted').innerHTML = `<i class="bi bi-clock me-2"></i>${currentJob.posted_date || 'Date not available'}`;

                // Job description
                document.getElementById('job-description').textContent = currentJob.description || 'No description available';

                // Responsibilities
                const responsibilitiesUl = document.getElementById('job-responsibilities');
                if (currentJob.responsibilities && currentJob.responsibilities.length > 0) {
                    responsibilitiesUl.innerHTML = currentJob.responsibilities.map(resp => `<li>${resp}</li>`).join('');
                } else {
                    responsibilitiesUl.innerHTML = '<li>No responsibilities listed</li>';
                }

                // Requirements
                const requirementsUl = document.getElementById('job-requirements');
                if (currentJob.requirements && currentJob.requirements.length > 0) {
                    requirementsUl.innerHTML = currentJob.requirements.map(req => `<li>${req}</li>`).join('');
                } else {
                    requirementsUl.innerHTML = '<li>No requirements listed</li>';
                }

                // Benefits
                const benefitsUl = document.getElementById('job-benefits');
                if (currentJob.benefits && currentJob.benefits.length > 0) {
                    benefitsUl.innerHTML = currentJob.benefits.map(benefit => `<li>${benefit}</li>`).join('');
                } else {
                    benefitsUl.innerHTML = '<li>No benefits listed</li>';
                }

                // Company sidebar info
                document.getElementById('company-name-sidebar').textContent = `About ${currentJob.company || 'Company'}`;
                document.getElementById('company-industry').textContent = currentJob.company_industry || 'Not specified';
                document.getElementById('company-size').textContent = currentJob.company_size || 'Not specified';
                document.getElementById('company-founded').textContent = currentJob.company_founded || 'Not specified';

                // Clear loading state
                setLoadingState(false);

                // Update save button
                updateSaveButton();

                // Check if user has already applied for this job
                checkApplicationStatus();

                // Load similar jobs
                loadSimilarJobs();

            } catch (error) {
                console.error("Error loading job:", error);
                setLoadingState(false);
                showErrorMessage("Failed to load job details. Please check your connection and try again.");
            }
        }

        // Set loading state for all elements
        function setLoadingState(isLoading) {
            const loadingElements = [
                'job-title', 'company-name', 'job-skills', 'job-location',
                'job-type', 'job-salary', 'job-posted', 'job-description',
                'job-responsibilities', 'job-requirements', 'job-benefits',
                'company-name-sidebar', 'company-industry', 'company-size', 'company-founded'
            ];

            loadingElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    if (isLoading) {
                        element.style.opacity = '0.6';
                        element.style.pointerEvents = 'none';
                    } else {
                        element.style.opacity = '1';
                        element.style.pointerEvents = 'auto';
                    }
                }
            });

            // Disable buttons during loading
            const buttons = document.querySelectorAll('#save-job-btn, #apply-now-btn');
            buttons.forEach(btn => {
                btn.disabled = isLoading;
            });
        }

        // Show error message
        function showErrorMessage(message) {
            // Create error alert
            const errorAlert = document.createElement('div');
            errorAlert.className = 'alert alert-danger alert-dismissible fade show';
            errorAlert.innerHTML = `
                <i class="bi bi-exclamation-triangle me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            // Insert at the top of the job details container
            const container = document.querySelector('.container.box-container');
            container.insertBefore(errorAlert, container.firstChild);

            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                if (errorAlert.parentNode) {
                    errorAlert.remove();
                }
            }, 5000);
        }

        // Update save button
        function updateSaveButton() {
            const saveBtn = document.getElementById('save-job-btn');
            const saveIcon = document.getElementById('save-job-icon');
            const saveText = document.getElementById('save-job-text');

            const isSaved = savedJobs.includes(currentJob.id);

            if (isSaved) {
                saveIcon.classList.remove('bi-bookmark');
                saveIcon.classList.add('bi-bookmark-fill');
                saveBtn.classList.remove('btn-outline-secondary');
                saveBtn.classList.add('btn-secondary');
                saveText.textContent = 'Saved!';
                saveBtn.setAttribute('title', 'Remove from Saved Jobs');
            } else {
                saveIcon.classList.remove('bi-bookmark-fill');
                saveIcon.classList.add('bi-bookmark');
                saveBtn.classList.remove('btn-secondary');
                saveBtn.classList.add('btn-outline-secondary');
                saveText.textContent = 'Save Job';
                saveBtn.setAttribute('title', 'Save this Job');
            }
        }

        // Check if user has already applied for this job
        function checkApplicationStatus() {
            const user = JSON.parse(localStorage.getItem("currentUser"));
            if (!user) return;

            // Import ProfileModel dynamically
            import('./models/ProfileModel.js').then(({ ProfileModel }) => {
                ProfileModel.load(user.id);
                const appliedJobs = ProfileModel.getAppliedJobs();
                const hasApplied = appliedJobs.some(job => job.jobId === currentJob.id);

                const applyBtn = document.querySelector('#apply-now-btn');
                if (hasApplied) {
                    applyBtn.textContent = 'Applied';
                    applyBtn.classList.remove('btn-apply');
                    applyBtn.classList.add('btn-success');
                    applyBtn.disabled = true;
                } else {
                    applyBtn.textContent = 'Apply Now';
                    applyBtn.classList.remove('btn-success');
                    applyBtn.classList.add('btn-apply');
                    applyBtn.disabled = false;
                }
            });
        }

        // Toggle save job
        function toggleSaveJob() {
            const index = savedJobs.indexOf(currentJob.id);
            if (index > -1) {
                savedJobs.splice(index, 1);
            } else {
                savedJobs.push(currentJob.id);
            }
            localStorage.setItem('savedJobs', JSON.stringify(savedJobs));
            updateSaveButton();
        }

        // Load similar jobs
        async function loadSimilarJobs() {
            if (!currentJob) return;

            try {
                const response = await fetch(`http://127.0.0.1:8000/jobs/${currentJob.id}/similar`);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const similarJobs = await response.json();
                renderSimilarJobs(similarJobs);

            } catch (error) {
                console.error("Error loading similar jobs:", error);
                // Show fallback message
                const container = document.getElementById('similar-jobs-container');
                container.innerHTML = '<p class="text-muted small">Unable to load similar jobs at this time.</p>';
            }
        }

        // Render similar jobs
        function renderSimilarJobs(jobs) {
            const container = document.getElementById('similar-jobs-container');

            if (!jobs || jobs.length === 0) {
                container.innerHTML = '<p class="text-muted small">No similar jobs found.</p>';
                return;
            }

            const jobsHtml = jobs.map((job, index) => {
                const borderClass = index < jobs.length - 1 ? 'border-bottom-light' : '';
                return `
                    <div class="similar-job-item pb-3 mb-3 ${borderClass}">
                        <a href="job-d.html?id=${job.id}" class="text-decoration-none text-dark">
                            <h6 class="small fw-bold mb-1">${job.title}</h6>
                            <p class="x-small text-muted mb-1">${job.company}</p>
                            <p class="x-small text-secondary mb-0"><i class="bi bi-geo-alt me-1"></i>${job.remote}</p>
                        </a>
                    </div>
                `;
            }).join('');

            container.innerHTML = jobsHtml;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadJob();

            // Save button listener
            document.getElementById('save-job-btn').addEventListener('click', toggleSaveJob);
        });
    </script>



    </body>
    </html>

